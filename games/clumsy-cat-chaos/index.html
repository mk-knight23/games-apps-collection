<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üê± Clumsy Cat Chaos - AI Enhanced</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); }
    .game-wrapper { max-width: 900px; width: 100%; padding: 20px; }
    .game-title { font-size: 2.5rem; text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats-panel { display: flex; justify-content: space-around; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--accent-primary); }
    canvas { width: 100%; border-radius: 12px; box-shadow: 0 8px 32px var(--shadow); display: block; }
    .controls { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
    .control-btn { padding: 15px 30px; border-radius: 10px; font-size: 1.5rem; }
    .back-btn { position: fixed; top: 20px; left: 20px; padding: 12px 24px; border-radius: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); cursor: pointer; backdrop-filter: blur(20px); }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="GameUtils.toggleTheme()"><span id="theme-icon">üåô</span></button>
  <button class="back-btn" onclick="window.location.href='../../index.html'">‚Üê Back</button>

  <div class="game-wrapper">
    <h1 class="game-title">üê± Clumsy Cat Chaos</h1>
    <div class="stats-panel glass">
      <div class="stat"><div class="stat-value" id="score">0</div><div>Score</div></div>
      <div class="stat"><div class="stat-value" id="level">1</div><div>Level</div></div>
      <div class="stat"><div class="stat-value" id="lives">3</div><div>Lives</div></div>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="controls">
      <button class="btn control-btn" onmousedown="moveLeft()" onmouseup="stopMove()">‚¨ÖÔ∏è</button>
      <button class="btn control-btn" onmousedown="jump()" onmouseup="stopJump()">‚¨ÜÔ∏è Jump</button>
      <button class="btn control-btn" onmousedown="moveRight()" onmouseup="stopMove()">‚û°Ô∏è</button>
    </div>
  </div>

  <div class="modal" id="gameOverModal">
    <div class="modal-content glass">
      <h2>üéÆ Game Over!</h2>
      <div style="font-size: 3rem; color: var(--accent-primary); margin: 20px 0;" id="finalScore">0</div>
      <p id="aiInsight"></p>
      <button class="btn" onclick="restartGame()">Play Again</button>
      <button class="btn" onclick="window.location.href='../../index.html'">Menu</button>
    </div>
  </div>

  <script src="../../assets/js/game-utils.js"></script>
  <script src="../../assets/js/ai-assistant.js"></script>
  <script src="../../assets/js/analytics.js"></script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ai = new AIAssistant();
    const analytics = new GameAnalytics('clumsy-cat');

    let game = {
      cat: { x: 100, y: 400, vx: 0, vy: 0, width: 40, height: 40, onGround: false },
      obstacles: [],
      score: 0,
      level: 1,
      lives: 3,
      particles: [],
      gameOver: false,
      moveLeft: false,
      moveRight: false,
      lastObstacle: 0
    };

    const gravity = 0.5;
    const jumpPower = -12;
    const moveSpeed = 5;

    function init() {
      GameUtils.initTheme();
      document.getElementById('theme-icon').textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);
      gameLoop();
      analytics.track('game_start');
    }

    function handleKeyDown(e) {
      if (e.key === 'ArrowLeft') game.moveLeft = true;
      if (e.key === 'ArrowRight') game.moveRight = true;
      if (e.key === 'ArrowUp' || e.key === ' ') jump();
    }

    function handleKeyUp(e) {
      if (e.key === 'ArrowLeft') game.moveLeft = false;
      if (e.key === 'ArrowRight') game.moveRight = false;
    }

    function moveLeft() { game.moveLeft = true; }
    function moveRight() { game.moveRight = true; }
    function stopMove() { game.moveLeft = false; game.moveRight = false; }
    function jump() { if (game.cat.onGround && !game.gameOver) { game.cat.vy = jumpPower; GameUtils.playSound(600, 100); } }
    function stopJump() {}

    function spawnObstacle() {
      const types = [
        { emoji: 'ü™¥', width: 40, height: 60, points: 10 },
        { emoji: 'üì¶', width: 50, height: 50, points: 15 },
        { emoji: 'üéæ', width: 30, height: 30, points: 20 }
      ];
      const type = types[Math.floor(Math.random() * types.length)];
      game.obstacles.push({
        x: canvas.width,
        y: canvas.height - 100 - type.height,
        vx: -3 - game.level * 0.5,
        ...type
      });
    }

    function update() {
      if (game.gameOver) return;

      const now = Date.now();

      // Cat movement
      if (game.moveLeft) game.cat.vx = -moveSpeed;
      else if (game.moveRight) game.cat.vx = moveSpeed;
      else game.cat.vx *= 0.8;

      game.cat.vy += gravity;
      game.cat.x += game.cat.vx;
      game.cat.y += game.cat.vy;

      // Boundaries
      if (game.cat.x < 0) game.cat.x = 0;
      if (game.cat.x > canvas.width - game.cat.width) game.cat.x = canvas.width - game.cat.width;

      // Ground collision
      if (game.cat.y >= canvas.height - 100 - game.cat.height) {
        game.cat.y = canvas.height - 100 - game.cat.height;
        game.cat.vy = 0;
        game.cat.onGround = true;
      } else {
        game.cat.onGround = false;
      }

      // Spawn obstacles
      if (now - game.lastObstacle > 2000 - game.level * 100) {
        spawnObstacle();
        game.lastObstacle = now;
      }

      // Update obstacles
      game.obstacles = game.obstacles.filter(obs => {
        obs.x += obs.vx;

        if (obs.x < -obs.width) {
          game.score += obs.points;
          return false;
        }

        // Collision
        if (game.cat.x < obs.x + obs.width &&
            game.cat.x + game.cat.width > obs.x &&
            game.cat.y < obs.y + obs.height &&
            game.cat.y + game.cat.height > obs.y) {
          game.lives--;
          game.particles.push(...GameUtils.createParticles(obs.x, obs.y, '#ef4444', 30));
          GameUtils.vibrate([100, 50, 100]);
          GameUtils.playSound(200, 200);
          if (game.lives <= 0) endGame();
          return false;
        }

        return true;
      });

      // Level up
      if (game.score > game.level * 100) {
        game.level++;
        game.lives = Math.min(3, game.lives + 1);
        analytics.track('level_up', { level: game.level });
      }

      game.particles = GameUtils.updateParticles(game.particles);

      document.getElementById('score').textContent = game.score;
      document.getElementById('level').textContent = game.level;
      document.getElementById('lives').textContent = game.lives;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Ground
      ctx.fillStyle = '#10b981';
      ctx.fillRect(0, canvas.height - 100, canvas.width, 100);

      // Cat
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('üê±', game.cat.x + game.cat.width / 2, game.cat.y + game.cat.height);

      // Obstacles
      game.obstacles.forEach(obs => {
        ctx.font = `${obs.height}px Arial`;
        ctx.fillText(obs.emoji, obs.x + obs.width / 2, obs.y + obs.height);
      });

      GameUtils.drawParticles(ctx, game.particles);
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function endGame() {
      game.gameOver = true;
      analytics.endSession(game.score);
      GameUtils.saveScore('clumsy-cat', game.score, { level: game.level });
      ai.saveProgress('clumsy-cat', { score: game.score, level: game.level });
      document.getElementById('finalScore').textContent = game.score;
      document.getElementById('aiInsight').textContent = ai.getRecommendation('clumsy-cat');
      document.getElementById('gameOverModal').classList.add('active');
    }

    function restartGame() {
      game = {
        cat: { x: 100, y: 400, vx: 0, vy: 0, width: 40, height: 40, onGround: false },
        obstacles: [],
        score: 0,
        level: 1,
        lives: 3,
        particles: [],
        gameOver: false,
        moveLeft: false,
        moveRight: false,
        lastObstacle: 0
      };
      document.getElementById('gameOverModal').classList.remove('active');
    }

    init();
  </script>
</body>
</html>
