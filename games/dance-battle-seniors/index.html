<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üï∫ Dance Battle Seniors - AI Enhanced</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); }
    .game-wrapper { max-width: 900px; width: 100%; padding: 20px; }
    .game-title { font-size: 2.5rem; text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #ec4899, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats-panel { display: flex; justify-content: space-around; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    canvas { width: 100%; border-radius: 12px; box-shadow: 0 8px 32px var(--shadow); display: block; }
    .dance-moves { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
    .move-btn { padding: 20px; border-radius: 10px; font-size: 2rem; }
    .back-btn { position: fixed; top: 20px; left: 20px; padding: 12px 24px; border-radius: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); cursor: pointer; backdrop-filter: blur(20px); }
    .combo-bar { height: 20px; background: var(--bg-tertiary); border-radius: 10px; overflow: hidden; margin-top: 10px; }
    .combo-fill { height: 100%; background: linear-gradient(90deg, #ec4899, #db2777); transition: width 0.3s ease; }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="GameUtils.toggleTheme()"><span id="theme-icon">üåô</span></button>
  <button class="back-btn" onclick="window.location.href='../../index.html'">‚Üê Back</button>

  <div class="game-wrapper">
    <h1 class="game-title">üï∫ Dance Battle Seniors</h1>
    <div class="stats-panel glass">
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="score">0</div><div>Score</div></div>
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="combo">0</div><div>Combo</div></div>
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="perfect">0</div><div>Perfect</div></div>
    </div>
    <div class="combo-bar glass"><div class="combo-fill" id="comboBar" style="width: 0%"></div></div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="dance-moves">
      <button class="btn move-btn" onclick="hitMove('‚¨ÖÔ∏è')">‚¨ÖÔ∏è</button>
      <button class="btn move-btn" onclick="hitMove('‚¨ÜÔ∏è')">‚¨ÜÔ∏è</button>
      <button class="btn move-btn" onclick="hitMove('‚¨áÔ∏è')">‚¨áÔ∏è</button>
      <button class="btn move-btn" onclick="hitMove('‚û°Ô∏è')">‚û°Ô∏è</button>
    </div>
  </div>

  <script src="../../assets/js/game-utils.js"></script>
  <script src="../../assets/js/ai-assistant.js"></script>
  <script src="../../assets/js/analytics.js"></script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ai = new AIAssistant();
    const analytics = new GameAnalytics('dance-battle');

    let game = {
      score: 0,
      combo: 0,
      perfect: 0,
      notes: [],
      dancer: { x: 400, y: 500, emoji: 'üï∫' },
      lastNote: 0,
      bpm: 120,
      particles: [],
      gameOver: false
    };

    const moves = ['‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚û°Ô∏è'];
    const hitZone = 100;

    function init() {
      GameUtils.initTheme();
      document.getElementById('theme-icon').textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      document.addEventListener('keydown', handleKey);
      gameLoop();
      analytics.track('game_start');
    }

    function handleKey(e) {
      const keyMap = { ArrowLeft: '‚¨ÖÔ∏è', ArrowUp: '‚¨ÜÔ∏è', ArrowDown: '‚¨áÔ∏è', ArrowRight: '‚û°Ô∏è' };
      if (keyMap[e.key]) hitMove(keyMap[e.key]);
    }

    function spawnNote() {
      const move = moves[Math.floor(Math.random() * moves.length)];
      const lanes = { '‚¨ÖÔ∏è': 200, '‚¨ÜÔ∏è': 350, '‚¨áÔ∏è': 450, '‚û°Ô∏è': 600 };
      game.notes.push({
        x: lanes[move],
        y: -50,
        move,
        speed: 3 + game.score / 500
      });
    }

    function hitMove(move) {
      const lane = { '‚¨ÖÔ∏è': 200, '‚¨ÜÔ∏è': 350, '‚¨áÔ∏è': 450, '‚û°Ô∏è': 600 }[move];
      const note = game.notes.find(n => n.move === move && Math.abs(n.y - hitZone) < 50);
      
      if (note) {
        const accuracy = Math.abs(n.y - hitZone);
        let points = 100;
        let rating = 'Good';
        
        if (accuracy < 15) {
          points = 200;
          rating = 'Perfect!';
          game.perfect++;
          game.combo++;
        } else if (accuracy < 30) {
          points = 150;
          rating = 'Great!';
          game.combo++;
        } else {
          game.combo = Math.max(0, game.combo - 1);
        }
        
        game.score += points * (1 + game.combo * 0.1);
        game.particles.push(...GameUtils.createParticles(lane, hitZone, '#ec4899', 25));
        GameUtils.playSound(800 + game.combo * 50, 100);
        GameUtils.vibrate([30]);
        
        game.notes = game.notes.filter(n => n !== note);
        
        document.getElementById('score').textContent = Math.round(game.score);
        document.getElementById('combo').textContent = game.combo;
        document.getElementById('perfect').textContent = game.perfect;
        document.getElementById('comboBar').style.width = Math.min(100, game.combo * 5) + '%';
      } else {
        game.combo = 0;
        document.getElementById('comboBar').style.width = '0%';
        GameUtils.playSound(200, 100);
      }
    }

    function update() {
      if (game.gameOver) return;

      const now = Date.now();
      const interval = 60000 / game.bpm;

      if (now - game.lastNote > interval) {
        spawnNote();
        game.lastNote = now;
      }

      game.notes = game.notes.filter(note => {
        note.y += note.speed;
        if (note.y > canvas.height) {
          game.combo = 0;
          document.getElementById('comboBar').style.width = '0%';
          return false;
        }
        return true;
      });

      game.particles = GameUtils.updateParticles(game.particles);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Lanes
      [200, 350, 450, 600].forEach(x => {
        ctx.strokeStyle = 'rgba(236, 72, 153, 0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      });

      // Hit zone
      ctx.fillStyle = 'rgba(236, 72, 153, 0.2)';
      ctx.fillRect(0, hitZone - 25, canvas.width, 50);

      // Notes
      ctx.font = '40px Arial';
      ctx.textAlign = 'center';
      game.notes.forEach(note => {
        ctx.fillText(note.move, note.x, note.y);
      });

      // Dancer
      ctx.font = '60px Arial';
      ctx.fillText(game.dancer.emoji, game.dancer.x, game.dancer.y);

      GameUtils.drawParticles(ctx, game.particles);
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    init();
  </script>
</body>
</html>
