<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçï Food Fight Frenzy - AI Enhanced</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); }
    .game-wrapper { max-width: 900px; width: 100%; padding: 20px; }
    .game-title { font-size: 2.5rem; text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, #f59e0b, #ea580c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats-panel { display: flex; justify-content: space-around; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    canvas { width: 100%; border-radius: 12px; box-shadow: 0 8px 32px var(--shadow); display: block; cursor: crosshair; }
    .weapons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
    .weapon-btn { padding: 15px; border-radius: 10px; font-size: 1.5rem; }
    .back-btn { position: fixed; top: 20px; left: 20px; padding: 12px 24px; border-radius: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); cursor: pointer; backdrop-filter: blur(20px); }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="GameUtils.toggleTheme()"><span id="theme-icon">üåô</span></button>
  <button class="back-btn" onclick="window.location.href='../../index.html'">‚Üê Back</button>

  <div class="game-wrapper">
    <h1 class="game-title">üçï Food Fight Frenzy</h1>
    <div class="stats-panel glass">
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="score">0</div><div>Score</div></div>
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="hits">0</div><div>Hits</div></div>
      <div><div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="ammo">‚àû</div><div>Ammo</div></div>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="weapons">
      <button class="btn weapon-btn selected" onclick="selectWeapon('pizza')" data-weapon="pizza">üçï</button>
      <button class="btn weapon-btn" onclick="selectWeapon('burger')" data-weapon="burger">üçî</button>
      <button class="btn weapon-btn" onclick="selectWeapon('taco')" data-weapon="taco">üåÆ</button>
      <button class="btn weapon-btn" onclick="selectWeapon('cake')" data-weapon="cake">üéÇ</button>
    </div>
  </div>

  <script src="../../assets/js/game-utils.js"></script>
  <script src="../../assets/js/ai-assistant.js"></script>
  <script src="../../assets/js/analytics.js"></script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ai = new AIAssistant();
    const analytics = new GameAnalytics('food-fight');

    let game = {
      player: { x: 400, y: 500, emoji: 'üßë', health: 100 },
      enemies: [],
      projectiles: [],
      enemyProjectiles: [],
      score: 0,
      hits: 0,
      weapon: 'pizza',
      lastEnemySpawn: 0,
      particles: [],
      gameOver: false
    };

    const weapons = {
      pizza: { emoji: 'üçï', damage: 20, speed: 8, color: '#f59e0b' },
      burger: { emoji: 'üçî', damage: 30, speed: 6, color: '#ea580c' },
      taco: { emoji: 'üåÆ', damage: 25, speed: 7, color: '#84cc16' },
      cake: { emoji: 'üéÇ', damage: 50, speed: 5, color: '#ec4899' }
    };

    function init() {
      GameUtils.initTheme();
      document.getElementById('theme-icon').textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      canvas.addEventListener('click', shoot);
      canvas.addEventListener('mousemove', updateAim);
      gameLoop();
      analytics.track('game_start');
    }

    let mouseX = 0, mouseY = 0;

    function updateAim(e) {
      const rect = canvas.getBoundingClientRect();
      mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
      mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);
    }

    function selectWeapon(type) {
      game.weapon = type;
      document.querySelectorAll('.weapon-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelector(`[data-weapon="${type}"]`).classList.add('selected');
      GameUtils.playSound(600, 50);
    }

    function shoot(e) {
      if (game.gameOver) return;
      
      const weapon = weapons[game.weapon];
      const angle = Math.atan2(mouseY - game.player.y, mouseX - game.player.x);
      
      game.projectiles.push({
        x: game.player.x,
        y: game.player.y,
        vx: Math.cos(angle) * weapon.speed,
        vy: Math.sin(angle) * weapon.speed,
        emoji: weapon.emoji,
        damage: weapon.damage,
        color: weapon.color
      });
      
      GameUtils.playSound(800, 100);
      GameUtils.vibrate([30]);
    }

    function spawnEnemy() {
      const aiConfig = ai.generateAIOpponent(ai.difficulty);
      const side = Math.random() < 0.5 ? 0 : canvas.width;
      
      game.enemies.push({
        x: side,
        y: Math.random() * (canvas.height - 200) + 100,
        vx: (side === 0 ? 1 : -1) * aiConfig.speed,
        health: 50,
        emoji: ['üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üßë‚Äçüç≥'][Math.floor(Math.random() * 3)],
        lastShot: 0
      });
    }

    function update() {
      if (game.gameOver) return;

      const now = Date.now();

      // Spawn enemies
      if (now - game.lastEnemySpawn > 2000) {
        spawnEnemy();
        game.lastEnemySpawn = now;
      }

      // Update projectiles
      game.projectiles = game.projectiles.filter(proj => {
        proj.x += proj.vx;
        proj.y += proj.vy;
        
        if (proj.x < 0 || proj.x > canvas.width || proj.y < 0 || proj.y > canvas.height) return false;

        const hit = game.enemies.find(e => Math.hypot(e.x - proj.x, e.y - proj.y) < 40);
        if (hit) {
          hit.health -= proj.damage;
          game.particles.push(...GameUtils.createParticles(proj.x, proj.y, proj.color, 20));
          GameUtils.playSound(600, 50);
          return false;
        }

        return true;
      });

      // Update enemies
      game.enemies = game.enemies.filter(enemy => {
        if (enemy.health <= 0) {
          game.score += 50;
          game.hits++;
          game.particles.push(...GameUtils.createParticles(enemy.x, enemy.y, '#10b981', 30));
          GameUtils.playSound(400, 100);
          return false;
        }

        enemy.x += enemy.vx;

        // Enemy shoots
        if (now - enemy.lastShot > 2000) {
          const angle = Math.atan2(game.player.y - enemy.y, game.player.x - enemy.x);
          game.enemyProjectiles.push({
            x: enemy.x,
            y: enemy.y,
            vx: Math.cos(angle) * 4,
            vy: Math.sin(angle) * 4,
            emoji: 'ü•ß'
          });
          enemy.lastShot = now;
        }

        return enemy.x > -50 && enemy.x < canvas.width + 50;
      });

      // Update enemy projectiles
      game.enemyProjectiles = game.enemyProjectiles.filter(proj => {
        proj.x += proj.vx;
        proj.y += proj.vy;

        if (Math.hypot(proj.x - game.player.x, proj.y - game.player.y) < 30) {
          game.player.health -= 10;
          game.particles.push(...GameUtils.createParticles(proj.x, proj.y, '#ef4444', 15));
          GameUtils.vibrate([100]);
          
          if (game.player.health <= 0) endGame();
          return false;
        }

        return proj.x > 0 && proj.x < canvas.width && proj.y > 0 && proj.y < canvas.height;
      });

      game.particles = GameUtils.updateParticles(game.particles);

      document.getElementById('score').textContent = game.score;
      document.getElementById('hits').textContent = game.hits;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Player
      ctx.font = '50px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(game.player.emoji, game.player.x, game.player.y);
      
      // Health bar
      ctx.fillStyle = '#ef4444';
      ctx.fillRect(game.player.x - 30, game.player.y - 40, 60, 6);
      ctx.fillStyle = '#10b981';
      ctx.fillRect(game.player.x - 30, game.player.y - 40, 60 * (game.player.health / 100), 6);

      // Enemies
      game.enemies.forEach(enemy => {
        ctx.fillText(enemy.emoji, enemy.x, enemy.y);
        ctx.fillStyle = '#ef4444';
        ctx.fillRect(enemy.x - 25, enemy.y - 35, 50, 5);
        ctx.fillStyle = '#10b981';
        ctx.fillRect(enemy.x - 25, enemy.y - 35, 50 * (enemy.health / 50), 5);
      });

      // Projectiles
      ctx.font = '30px Arial';
      game.projectiles.forEach(proj => ctx.fillText(proj.emoji, proj.x, proj.y));
      game.enemyProjectiles.forEach(proj => ctx.fillText(proj.emoji, proj.x, proj.y));

      // Crosshair
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(mouseX, mouseY, 20, 0, Math.PI * 2);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(mouseX - 25, mouseY);
      ctx.lineTo(mouseX + 25, mouseY);
      ctx.moveTo(mouseX, mouseY - 25);
      ctx.lineTo(mouseX, mouseY + 25);
      ctx.stroke();

      GameUtils.drawParticles(ctx, game.particles);
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    function endGame() {
      game.gameOver = true;
      analytics.endSession(game.score);
      GameUtils.saveScore('food-fight', game.score, { hits: game.hits });
      alert(`Game Over! Score: ${game.score}\n${ai.getRecommendation('food-fight')}`);
      window.location.href = '../../index.html';
    }

    init();
  </script>
</body>
</html>
